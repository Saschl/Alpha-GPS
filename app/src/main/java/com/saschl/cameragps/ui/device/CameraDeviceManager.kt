package com.saschl.cameragps.ui.device

import android.annotation.SuppressLint
import android.bluetooth.BluetoothAdapter
import android.bluetooth.BluetoothManager
import android.companion.CompanionDeviceManager
import android.companion.ObservingDevicePresenceRequest
import android.content.Intent
import android.content.IntentFilter
import android.location.LocationManager
import android.os.Build
import androidx.activity.compose.LocalActivity
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.DisposableEffect
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.runtime.setValue
import androidx.compose.ui.platform.LocalContext
import androidx.core.content.ContextCompat
import androidx.core.content.getSystemService
import androidx.lifecycle.Lifecycle
import androidx.lifecycle.compose.LocalLifecycleOwner
import com.google.android.play.core.review.ReviewException
import com.google.android.play.core.review.ReviewManagerFactory
import com.google.android.play.core.review.model.ReviewErrorCode
import com.saschl.cameragps.database.LogDatabase
import com.saschl.cameragps.database.devices.CameraDevice
import com.saschl.cameragps.service.AssociatedDeviceCompat
import com.saschl.cameragps.service.BluetoothStateBroadcastReceiver
import com.saschl.cameragps.service.LocationSenderService
import com.saschl.cameragps.service.SonyBluetoothConstants
import com.saschl.cameragps.service.getAssociatedDevices
import com.saschl.cameragps.ui.EnhancedLocationPermissionBox
import com.saschl.cameragps.ui.pairing.startDevicePresenceObservation
import com.saschl.cameragps.utils.PreferencesManager
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch
import timber.log.Timber

@SuppressLint("MissingPermission")
@Composable
fun CameraDeviceManager(
    onSettingsClick: () -> Unit = {}
) {
    val context = LocalContext.current
    val scope = rememberCoroutineScope()
    val deviceManager = context.getSystemService<CompanionDeviceManager>()
    val devicesDao = LogDatabase.getDatabase(context).cameraDeviceDao()
    val adapter = context.getSystemService<BluetoothManager>()?.adapter
    val locationManager = context.getSystemService<LocationManager>()
    var selectedDevice by remember {
        mutableStateOf<AssociatedDeviceCompat?>(null)
    }

    val manager = ReviewManagerFactory.create(context)

    val activity = LocalActivity.current

    val lifecycleOwner = LocalLifecycleOwner.current
    val lifecycleState by lifecycleOwner.lifecycle.currentStateFlow.collectAsState()

    var associatedDevices by remember {
        mutableStateOf(deviceManager!!.getAssociatedDevices(adapter!!))
    }

    var isBluetoothEnabled by remember {
        mutableStateOf(adapter?.isEnabled == true)
    }

    var isLocationEnabled by remember {
        mutableStateOf(locationManager?.isProviderEnabled(LocationManager.GPS_PROVIDER) == true ||
                      locationManager?.isProviderEnabled(LocationManager.NETWORK_PROVIDER) == true)
    }

    LaunchedEffect(associatedDevices) {
        associatedDevices.forEach {
            devicesDao.insertDevice(
                CameraDevice(
                    deviceName = it.name,
                    mac = it.address.uppercase(),
                    alwaysOnEnabled = false,
                    deviceEnabled = true,
                )
            )
        }
    }

    LaunchedEffect(associatedDevices, lifecycleState) {
        if (associatedDevices.isNotEmpty() && PreferencesManager.reviewHintLastShownDaysAgo(
                context.applicationContext,
                true
            ) >= 30
            && lifecycleState.isAtLeast(Lifecycle.State.STARTED) && PreferencesManager.reviewHintShownTimes(context.applicationContext) < 3
        ) {
            val request = manager.requestReviewFlow()
            PreferencesManager.setReviewHintShownNow(context.applicationContext)
            PreferencesManager.increaseReviewHintShownTimes(context.applicationContext)
            request.addOnCompleteListener { task ->
                if (task.isSuccessful) {
                    // We got the ReviewInfo object
                    val reviewInfo = task.result
                    val flow = manager.launchReviewFlow(activity!! , reviewInfo)
                    flow.addOnCompleteListener { _ ->
                        Timber.i("Review done!")
                    }
                } else {
                    // There was some problem, log or handle the error code.
                    @ReviewErrorCode val reviewErrorCode = (task.exception as ReviewException).errorCode
                    Timber.e("Review flow failed with error code: $reviewErrorCode")
                    PreferencesManager.resetReviewHintShown(context.applicationContext)
                    PreferencesManager.decreaseReviewHintShownTimes(context.applicationContext)
                }
            }
        }
    }

    DisposableEffect(context) {
        val bluetoothReceiver = BluetoothStateBroadcastReceiver { enabled ->
            isBluetoothEnabled = enabled
        }

        val filter = IntentFilter(BluetoothAdapter.ACTION_STATE_CHANGED)
        ContextCompat.registerReceiver(
            context.applicationContext,
            bluetoothReceiver,
            filter,
            ContextCompat.RECEIVER_NOT_EXPORTED
        )

        onDispose {
            context.applicationContext.unregisterReceiver(bluetoothReceiver)
        }
    }

    LaunchedEffect(lifecycleState) {
        when (lifecycleState) {
            Lifecycle.State.RESUMED -> {
                associatedDevices = deviceManager!!.getAssociatedDevices(adapter!!)
                isBluetoothEnabled = adapter.isEnabled == true
                isLocationEnabled = locationManager?.isProviderEnabled(LocationManager.GPS_PROVIDER) == true ||
                                  locationManager?.isProviderEnabled(LocationManager.NETWORK_PROVIDER) == true
            }
            else -> { /* No action needed */
            }
        }
    }

    if (deviceManager == null || adapter == null) {
        Text(text = "No Companion device manager found. The device does not support it.")
    } else {
        if (selectedDevice == null) {
            EnhancedLocationPermissionBox {
                DevicesScreen(
                    deviceManager = deviceManager,
                    isBluetoothEnabled = isBluetoothEnabled,
                    isLocationEnabled = isLocationEnabled,
                    associatedDevices = associatedDevices,
                    onDeviceAssociated = {
                        scope.launch {
                            devicesDao.insertDevice(
                                CameraDevice(
                                    deviceName = it.name,
                                    mac = it.address.uppercase(),
                                    alwaysOnEnabled = false,
                                    deviceEnabled = true,
                                )
                            )
                            delay(1000) // give the system a short time to breathe
                            startDevicePresenceObservation(deviceManager, it)
                        }
                    },
                    onConnect = { device ->
                        selectedDevice = device
                    },
                    onSettingsClick = onSettingsClick
                )
            }
        } else {
            EnhancedLocationPermissionBox {
                DeviceDetailScreen(
                    device = selectedDevice!!,
                    deviceManager = deviceManager,
                    associationId = deviceManager.getAssociatedDevices(adapter)
                        .find { it.address == selectedDevice?.address }?.id!!,
                    onDisassociate = { device ->
                        associatedDevices.find { ass -> ass.address == device.address }
                            ?.let { foundDevice ->
                                Timber.i("Disassociating device: ${foundDevice.name} (${foundDevice.address})")
                                scope.launch {

                                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.BAKLAVA) {
                                        deviceManager.stopObservingDevicePresence(
                                            ObservingDevicePresenceRequest.Builder()
                                                .setAssociationId(foundDevice.id).build()
                                        )
                                    } else if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                                        @Suppress("DEPRECATION")
                                        deviceManager.stopObservingDevicePresence(foundDevice.address)
                                    }

                                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                                        deviceManager.disassociate(foundDevice.id)
                                    } else {
                                        @Suppress("DEPRECATION")
                                        deviceManager.disassociate(foundDevice.address)
                                    }

                                    val serviceIntent = Intent(
                                        context.applicationContext,
                                        LocationSenderService::class.java
                                    ).apply {
                                        action = SonyBluetoothConstants.ACTION_REQUEST_SHUTDOWN
                                    }
                                    serviceIntent.putExtra(
                                        "address",
                                        foundDevice.address.uppercase()
                                    )
                                    context.startService(serviceIntent)

                                    devicesDao.deleteDevice(CameraDevice(foundDevice.address.uppercase()))

                                    associatedDevices = deviceManager.getAssociatedDevices(adapter)
                                }
                                selectedDevice = null
                            }
                    },
                    onClose = { selectedDevice = null }
                )
            }
        }
    }
}
